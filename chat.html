<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoknowGram PRO</title>
    <style>
        /* –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f24;
            --bg-tertiary: #252a31;
            --accent-primary: #00d4aa;
            --accent-secondary: #0099ff;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --danger: #ff4444;
            --success: #00c851;
            --warning: #ffbb33;
            --border-color: #2d3748;
        }

        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */

    </style>
</head>
<body>
    <!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="app-container">
        <!-- –°–∞–π–¥–±–∞—Ä –∏ –æ—Å—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        class ChatApp {
            constructor() {
                this.currentUser = null;
                this.currentRoom = null;
                this.socket = null;
                this.typingTimer = null;
                this.typingUsers = new Set();
                
                // WebRTC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
                this.peerConnection = null;
                this.localStream = null;
                this.remoteStream = null;
                this.isInCall = false;
                this.isCaller = false;
                this.callStartTime = null;
                this.callTimerInterval = null;
                this.currentCaller = null;
                this.currentCallType = null;
                this.currentCallId = null;
                this.targetUser = null;
                this.callSound = null;
                this.isScreenSharing = false;
                this.remoteOffer = null;
                this.pendingCandidates = [];
                this.isCallAccepted = false;
                
                // –î–∞–Ω–Ω—ã–µ
                this.onlineUsers = [];
                this.userGroups = [];
                this.selectedUsers = new Set();
                
                this.init();
            }

            init() {
                this.checkAuth();
                this.setupElements();
                this.connectSocket();
                this.bindEvents();
                this.loadGlobalChats();
            }

            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ —Ä–∞–∑–¥–µ–ª–∞ –∑–≤–æ–Ω–∫–æ–≤ ...

            // WebRTC –†–ï–ê–õ–¨–ù–´–ï –ó–í–û–ù–ö–ò - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
            async startCall(type) {
                if (!this.currentRoom) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞');
                    return;
                }

                if (this.isInCall) {
                    alert('–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ');
                    return;
                }

                try {
                    this.currentCallType = type;
                    this.isCaller = true;
                    this.isCallAccepted = false;
                    this.currentCallId = 'call_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫
                    await this.getUserMedia();

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å –∑–≤–æ–Ω–∫–∞
                    let target = this.currentRoom;
                    let targetUser = null;
                    
                    if (this.currentRoom.startsWith('private_')) {
                        const users = this.currentRoom.replace('private_', '').split('_');
                        targetUser = users.find(user => user !== this.currentUser.username);
                        target = targetUser;
                    }

                    this.targetUser = targetUser;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞
                    this.showCallWindow(`–ó–≤–æ–Ω–æ–∫ ${this.getRoomName(this.currentRoom)}`, '–í—ã–∑–æ–≤...');
                    this.callWith.textContent = `–í: ${this.getRoomName(this.currentRoom)}`;

                    // –°–æ–∑–¥–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    await this.createPeerConnection();

                    // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ñ—Ñ–µ—Ä
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);

                    console.log('Sending call offer to:', target, 'call_id:', this.currentCallId);

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–≤–æ–Ω–æ–∫
                    this.socket.emit('start_call', {
                        username: this.currentUser.username,
                        target: target,
                        target_user: targetUser,
                        type: type,
                        call_id: this.currentCallId,
                        room: this.currentRoom,
                        is_group: this.currentRoom.startsWith('group_')
                    });

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º WebRTC –æ—Ñ—Ñ–µ—Ä
                    this.socket.emit('webrtc_offer', {
                        offer: offer,
                        caller: this.currentUser.username,
                        target: target,
                        target_user: targetUser,
                        call_id: this.currentCallId,
                        room: this.currentRoom
                    });

                    // –¢–∞–π–º–∞—É—Ç –Ω–∞ –æ—Ç–≤–µ—Ç
                    this.callTimeout = setTimeout(() => {
                        if (this.isInCall && this.isCaller && !this.isCallAccepted) {
                            this.addSystemMessage('‚ùå –ù–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –∑–≤–æ–Ω–æ–∫');
                            this.endCall();
                        }
                    }, 30000);

                } catch (error) {
                    console.error('Error starting call:', error);
                    this.addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–≤–æ–Ω–∫–∞: ' + error.message);
                    this.endCall();
                }
            }

            async getUserMedia() {
                try {
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1
                        },
                        video: this.currentCallType === 'video' ? {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            frameRate: { ideal: 24 }
                        } : false
                    };

                    console.log('Requesting media with constraints:', constraints);
                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    console.log('Got media stream:', this.localStream);
                    console.log('Audio tracks:', this.localStream.getAudioTracks());
                    console.log('Video tracks:', this.localStream.getVideoTracks());

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    if (this.localVideo) {
                        this.localVideo.srcObject = this.localStream;
                        this.localVideo.muted = true; // –í—Å–µ–≥–¥–∞ mute –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    }

                    return this.localStream;
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    let errorMessage = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ ';
                    
                    if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage += '–∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.';
                    } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage += '–∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage += '–∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                    } else {
                        errorMessage += '–∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
                    }
                    
                    this.addSystemMessage(errorMessage);
                    throw error;
                }
            }

            async createPeerConnection() {
                try {
                    const configuration = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ],
                        iceCandidatePoolSize: 10
                    };

                    console.log('Creating peer connection with config:', configuration);
                    this.peerConnection = new RTCPeerConnection(configuration);

                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                    if (this.localStream) {
                        this.localStream.getTracks().forEach(track => {
                            console.log('Adding local track:', track.kind, track.id);
                            this.peerConnection.addTrack(track, this.localStream);
                        });
                    }

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô
                    this.peerConnection.ontrack = (event) => {
                        console.log('Received remote track:', event.track.kind, event.streams);
                        
                        if (event.streams && event.streams[0]) {
                            this.remoteStream = event.streams[0];
                            
                            if (this.remoteVideo) {
                                this.remoteVideo.srcObject = this.remoteStream;
                                this.videoPlaceholder.style.display = 'none';
                                
                                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                                this.remoteVideo.play().catch(e => {
                                    console.log('Auto-play prevented, adding user gesture requirement');
                                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                                    document.addEventListener('click', () => {
                                        this.remoteVideo.play().catch(console.error);
                                    }, { once: true });
                                });
                            }
                        }
                    };

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ - –£–õ–£–ß–®–ï–ù–ù–´–ô
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log('New ICE candidate:', event.candidate);
                            
                            let target = this.currentRoom;
                            let targetUser = this.targetUser;
                            
                            if (this.currentRoom.startsWith('private_')) {
                                const users = this.currentRoom.replace('private_', '').split('_');
                                targetUser = users.find(user => user !== this.currentUser.username);
                                target = targetUser;
                            }

                            this.socket.emit('webrtc_ice_candidate', {
                                candidate: event.candidate,
                                call_id: this.currentCallId,
                                target_user: targetUser,
                                target: target,
                                caller: this.currentUser.username,
                                room: this.currentRoom
                            });
                        } else {
                            console.log('All ICE candidates have been sent');
                        }
                    };

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è - –£–õ–£–ß–®–ï–ù–ù–´–ô
                    this.peerConnection.onconnectionstatechange = () => {
                        const state = this.peerConnection.connectionState;
                        console.log('Connection state changed:', state);
                        
                        switch (state) {
                            case 'connected':
                                this.callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                                this.addSystemMessage('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                                this.isCallAccepted = true;
                                break;
                            case 'connecting':
                                this.callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
                                break;
                            case 'disconnected':
                                this.callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ';
                                this.addSystemMessage('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ');
                                break;
                            case 'failed':
                                this.callStatus.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                                this.addSystemMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                                this.endCall();
                                break;
                            case 'closed':
                                console.log('Peer connection closed');
                                break;
                        }
                    };

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    this.peerConnection.oniceconnectionstatechange = () => {
                        console.log('ICE connection state:', this.peerConnection.iceConnectionState);
                    };

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ gathering —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    this.peerConnection.onicegatheringstatechange = () => {
                        console.log('ICE gathering state:', this.peerConnection.iceGatheringState);
                    };

                } catch (error) {
                    console.error('Error creating peer connection:', error);
                    throw error;
                }
            }

            async handleIncomingCall(caller, type, call_id, is_group = false, group_name = '') {
                if (this.isInCall) {
                    this.socket.emit('reject_call', {
                        username: this.currentUser.username,
                        caller: caller,
                        call_id: call_id
                    });
                    return;
                }

                console.log('Incoming call from:', caller, 'type:', type, 'call_id:', call_id);

                this.currentCaller = caller;
                this.currentCallType = type;
                this.currentCallId = call_id;
                this.isCallAccepted = false;

                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
                this.playCallSound('incoming');

                this.callerName.textContent = `–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${caller}`;
                this.callerAvatar.textContent = caller.charAt(0).toUpperCase();
                this.callType.textContent = type === 'voice' ? '–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫' : '–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫';
                this.incomingCallModal.classList.add('active');

                // –¢–∞–π–º–∞—É—Ç –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
                this.incomingCallTimeout = setTimeout(() => {
                    if (this.incomingCallModal.classList.contains('active')) {
                        this.rejectCall();
                    }
                }, 45000);
            }

            async acceptCall() {
                try {
                    console.log('Accepting call:', this.currentCallId);
                    
                    this.incomingCallModal.classList.remove('active');
                    this.isInCall = true;
                    this.stopCallSound();
                    
                    if (this.incomingCallTimeout) {
                        clearTimeout(this.incomingCallTimeout);
                        this.incomingCallTimeout = null;
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫
                    await this.getUserMedia();
                    
                    // –°–æ–∑–¥–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    await this.createPeerConnection();

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞
                    this.showCallWindow(`–ó–≤–æ–Ω–æ–∫ —Å ${this.currentCaller}`, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                    this.callWith.textContent = `–°: ${this.currentCaller}`;
                    this.startCallTimer();

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ—Ñ—Ñ–µ—Ä) –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    if (this.remoteOffer) {
                        console.log('Setting remote description from pending offer');
                        await this.peerConnection.setRemoteDescription(this.remoteOffer);
                        
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                        this.pendingCandidates.forEach(candidate => {
                            this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .catch(e => console.error('Error adding pending candidate:', e));
                        });
                        this.pendingCandidates = [];
                        
                        // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                        const answer = await this.peerConnection.createAnswer();
                        await this.peerConnection.setLocalDescription(answer);

                        console.log('Sending WebRTC answer for call:', this.currentCallId);

                        this.socket.emit('webrtc_answer', {
                            answer: answer,
                            caller: this.currentCaller,
                            call_id: this.currentCallId,
                            target_user: this.currentCaller
                        });
                    } else {
                        console.warn('No remote offer available when accepting call');
                    }

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∑–≤–æ–Ω—è—â–µ–≥–æ –æ –ø—Ä–∏–Ω—è—Ç–∏–∏
                    this.socket.emit('accept_call', {
                        username: this.currentUser.username,
                        caller: this.currentCaller,
                        call_id: this.currentCallId
                    });

                    this.addSystemMessage(`üìû –í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–≤–æ–Ω–æ–∫ –æ—Ç ${this.currentCaller}`);

                } catch (error) {
                    console.error('Error accepting call:', error);
                    this.addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞: ' + error.message);
                    this.endCall();
                }
            }

            rejectCall() {
                console.log('Rejecting call:', this.currentCallId);
                
                this.incomingCallModal.classList.remove('active');
                this.stopCallSound();
                
                if (this.incomingCallTimeout) {
                    clearTimeout(this.incomingCallTimeout);
                    this.incomingCallTimeout = null;
                }
                
                this.socket.emit('reject_call', {
                    username: this.currentUser.username,
                    caller: this.currentCaller,
                    call_id: this.currentCallId
                });

                this.addSystemMessage(`‚ùå –í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –∑–≤–æ–Ω–æ–∫ –æ—Ç ${this.currentCaller}`);
                this.resetCallData();
            }

            // WebRTC –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
            async handleWebRTCOffer(data) {
                console.log('Received WebRTC offer:', data);
                
                if (!this.currentCallId || this.currentCallId === data.call_id) {
                    this.remoteOffer = new RTCSessionDescription(data.offer);
                    this.currentCallId = data.call_id;
                    this.currentCaller = data.caller;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ñ—Ñ–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–≤–æ–Ω–∫–∞
                    console.log('Stored remote offer for call:', this.currentCallId);
                }
            }

            async handleWebRTCAnswer(data) {
                console.log('Received WebRTC answer:', data);
                
                if (this.currentCallId === data.call_id && this.peerConnection) {
                    try {
                        const answer = new RTCSessionDescription(data.answer);
                        await this.peerConnection.setRemoteDescription(answer);
                        console.log('Remote description set successfully');
                        
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                        this.pendingCandidates.forEach(candidate => {
                            this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .catch(e => console.error('Error adding pending candidate:', e));
                        });
                        this.pendingCandidates = [];
                        
                    } catch (error) {
                        console.error('Error setting remote description:', error);
                    }
                }
            }

            async handleWebRTCIceCandidate(data) {
                console.log('Received ICE candidate:', data);
                
                if (this.currentCallId === data.call_id) {
                    try {
                        if (this.peerConnection && this.peerConnection.remoteDescription) {
                            await this.peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                            console.log('ICE candidate added successfully');
                        } else {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ remote description
                            this.pendingCandidates.push(data.candidate);
                            console.log('ICE candidate stored as pending');
                        }
                    } catch (error) {
                        console.error('Error adding ICE candidate:', error);
                    }
                }
            }

            // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø
            async toggleScreenShare() {
                if (!this.isInCall) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∑–≤–æ–Ω–æ–∫');
                    return;
                }

                try {
                    if (!this.isScreenSharing) {
                        const screenStream = await navigator.mediaDevices.getDisplayMedia({
                            video: {
                                cursor: 'always',
                                displaySurface: 'window'
                            },
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                sampleRate: 44100
                            }
                        });
                        
                        console.log('Screen share stream:', screenStream);
                        
                        const videoTrack = screenStream.getVideoTracks()[0];
                        const audioTrack = screenStream.getAudioTracks()[0];
                        
                        // –ù–∞—Ö–æ–¥–∏–º sender'—ã –¥–ª—è –∑–∞–º–µ–Ω—ã
                        const senders = this.peerConnection.getSenders();
                        
                        if (videoTrack) {
                            const videoSender = senders.find(s => s.track && s.track.kind === 'video');
                            if (videoSender) {
                                await videoSender.replaceTrack(videoTrack);
                                console.log('Replaced video track with screen share');
                            }
                        }
                        
                        if (audioTrack) {
                            const audioSender = senders.find(s => s.track && s.track.kind === 'audio');
                            if (audioSender) {
                                await audioSender.replaceTrack(audioTrack);
                                console.log('Replaced audio track with screen share audio');
                            }
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
                        videoTrack.onended = () => {
                            console.log('Screen share ended by user');
                            this.toggleScreenShare();
                        };
                        
                        this.isScreenSharing = true;
                        this.screenShareCallBtn.style.background = 'var(--success)';
                        this.addSystemMessage('üñ•Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç–∞');
                        
                    } else {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                        const senders = this.peerConnection.getSenders();
                        
                        if (this.localStream) {
                            const originalVideoTrack = this.localStream.getVideoTracks()[0];
                            const originalAudioTrack = this.localStream.getAudioTracks()[0];
                            
                            if (originalVideoTrack) {
                                const videoSender = senders.find(s => s.track && s.track.kind === 'video');
                                if (videoSender) {
                                    await videoSender.replaceTrack(originalVideoTrack);
                                }
                            }
                            
                            if (originalAudioTrack) {
                                const audioSender = senders.find(s => s.track && s.track.kind === 'audio');
                                if (audioSender) {
                                    await audioSender.replaceTrack(originalAudioTrack);
                                }
                            }
                        }
                        
                        this.isScreenSharing = false;
                        this.screenShareCallBtn.style.background = 'var(--warning)';
                        this.addSystemMessage('üñ•Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                    }
                } catch (error) {
                    console.error('Error toggling screen share:', error);
                    this.addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞: ' + error.message);
                }
            }

            // –ó–í–£–ö –ó–í–û–ù–ö–ê - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
            playCallSound(type) {
                this.stopCallSound();
                
                try {
                    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ —á–µ—Ä–µ–∑ HTMLAudioElement
                    if (type === 'incoming') {
                        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –±–∏–ø-–±–∏–ø –∑–≤—É–∫
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.type = 'sine';
                        gainNode.gain.value = 0.1;
                        
                        // –ü–∞—Ç—Ç–µ—Ä–Ω –∑–≤–æ–Ω–∫–∞: –±–∏–ø-–±–∏–ø-–ø–∞—É–∑–∞
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.4);
                        
                        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                        this.callSound = setInterval(() => {
                            const newOscillator = audioContext.createOscillator();
                            const newGain = audioContext.createGain();
                            
                            newOscillator.connect(newGain);
                            newGain.connect(audioContext.destination);
                            
                            newOscillator.type = 'sine';
                            newGain.gain.value = 0.1;
                            
                            newOscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                            newOscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                            newOscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                            newOscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.3);
                            
                            newOscillator.start();
                            newOscillator.stop(audioContext.currentTime + 0.4);
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error playing call sound:', error);
                }
            }

            stopCallSound() {
                if (this.callSound) {
                    if (typeof this.callSound === 'number') {
                        clearInterval(this.callSound);
                    }
                    this.callSound = null;
                }
            }

            // –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
            showCallWindow(title, status) {
                this.callTitle.textContent = title;
                this.callStatus.textContent = status;
                this.callWindow.classList.add('active');
                this.videoPlaceholder.style.display = 'flex';
                this.isInCall = true;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                this.callMuteBtn.classList.remove('mute');
                this.callVideoBtn.classList.remove('video-off');
                this.screenShareCallBtn.style.background = 'var(--warning)';
            }

            startCallTimer() {
                this.callStartTime = new Date();
                this.updateCallTimer();
                this.callTimerInterval = setInterval(() => this.updateCallTimer(), 1000);
            }

            updateCallTimer() {
                if (this.callStartTime) {
                    const now = new Date();
                    const diff = Math.floor((now - this.callStartTime) / 1000);
                    const minutes = Math.floor(diff / 60);
                    const seconds = diff % 60;
                    this.callTimer.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            toggleMute() {
                const isMuted = this.callMuteBtn.classList.toggle('mute');
                
                if (this.localStream) {
                    const audioTracks = this.localStream.getAudioTracks();
                    audioTracks.forEach(track => {
                        track.enabled = !isMuted;
                        console.log('Audio track enabled:', track.enabled);
                    });
                }
                
                this.addSystemMessage(isMuted ? 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
            }

            toggleVideo() {
                const isVideoOff = this.callVideoBtn.classList.toggle('video-off');
                
                if (this.localStream) {
                    const videoTracks = this.localStream.getVideoTracks();
                    videoTracks.forEach(track => {
                        track.enabled = !isVideoOff;
                        console.log('Video track enabled:', track.enabled);
                    });
                }
                
                this.addSystemMessage(isVideoOff ? 'üìπ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞' : 'üìπ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞');
            }

            endCall() {
                console.log('Ending call');
                
                this.isInCall = false;
                this.isCaller = false;
                this.isCallAccepted = false;
                this.isScreenSharing = false;
                this.stopCallSound();
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∏
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('Stopped track:', track.kind);
                    });
                    this.localStream = null;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                
                // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
                if (this.callTimerInterval) {
                    clearInterval(this.callTimerInterval);
                    this.callTimerInterval = null;
                }
                
                if (this.callTimeout) {
                    clearTimeout(this.callTimeout);
                    this.callTimeout = null;
                }

                if (this.incomingCallTimeout) {
                    clearTimeout(this.incomingCallTimeout);
                    this.incomingCallTimeout = null;
                }

                // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–∞
                this.callWindow.classList.remove('active');
                this.incomingCallModal.classList.remove('active');

                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞
                if (this.currentCallId) {
                    this.socket.emit('end_call', {
                        username: this.currentUser.username,
                        call_id: this.currentCallId
                    });
                    
                    this.socket.emit('webrtc_end_call', {
                        call_id: this.currentCallId
                    });
                }

                this.resetCallData();
                this.addSystemMessage('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            }

            resetCallData() {
                this.currentCaller = null;
                this.targetUser = null;
                this.currentCallId = null;
                this.currentCallType = null;
                this.remoteOffer = null;
                this.pendingCandidates = [];
                this.isCallAccepted = false;
                this.remoteStream = null;
                
                // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (this.localVideo) {
                    this.localVideo.srcObject = null;
                }
                if (this.remoteVideo) {
                    this.remoteVideo.srcObject = null;
                }
            }

            handleCallAccepted(acceptedBy, call_id) {
                console.log('Call accepted by:', acceptedBy);
                
                if (this.isCaller && this.currentCallId === call_id) {
                    this.stopCallSound();
                    this.callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
                    this.startCallTimer();
                    this.isCallAccepted = true;
                    this.addSystemMessage(`‚úÖ ${acceptedBy} –ø—Ä–∏–Ω—è–ª –∑–≤–æ–Ω–æ–∫`);
                    
                    if (this.callTimeout) {
                        clearTimeout(this.callTimeout);
                        this.callTimeout = null;
                    }
                }
            }

            handleCallRejected(rejectedBy) {
                console.log('Call rejected by:', rejectedBy);
                
                if (this.isCaller) {
                    this.stopCallSound();
                    this.addSystemMessage(`‚ùå ${rejectedBy} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–≤–æ–Ω–æ–∫`);
                    this.endCall();
                }
            }

            handleCallEnded(endedBy) {
                console.log('Call ended by:', endedBy);
                
                if (this.isInCall) {
                    this.stopCallSound();
                    this.addSystemMessage(`üìû ${endedBy} –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫`);
                    this.endCall();
                }
            }

            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            const chatApp = new ChatApp();
        });
    </script>
</body>
</html>
